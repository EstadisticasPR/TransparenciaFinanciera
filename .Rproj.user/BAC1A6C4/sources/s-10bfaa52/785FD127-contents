library(ggplot2)
library(plotly)

data <- read.csv("transparencia.csv")

# Person Anual
name_year = aggregate(amount~name, data, sum)
name_year = name_year[order(-name_year$amount),]
top_nm = name_year[1:10, 1]

name_year_amount = aggregate(amount~fiscal_year+name, data, sum)
name_year_amount$amount = name_year_amount$amount/1e6

name_year_amount$top5 = numeric(length(name_year_amount$name))

for (i in 1:length(name_year_amount$name)){
  if (name_year_amount$name[i] %in% top_nm){
    name_year_amount$top5[i] = "top5"
  } else {
    name_year_amount$top5[i] = "notTop5"
  }
}

name_year_amount = subset(name_year_amount, top5 == "top5")

p <- ggplot(data = name_year_amount) +
  geom_line(mapping = aes(x = fiscal_year, y = amount, colour = name)) +
  labs(x = "Año Fiscal",
       y = "Cantidad en Millones de $",
       title = "Gasto por Persona Anual", 
       colour = "Persona")

p <- ggplotly(p)
p

# Person Mes

name_month_amount = aggregate(amount~fiscal_year_period+name+fiscal_year, data, sum)
name_month_amount$amount = name_month_amount$amount/1e6
name_month_amount$dates <- paste0(name_month_amount$fiscal_year, "/", name_month_amount$fiscal_year_period, "/1")

name_month_amount$dates <- as.Date(name_month_amount$dates)

name_month_amount$top5 = numeric(length(name_month_amount$name))

for (i in 1:length(name_month_amount$name)){
  if (name_month_amount$name[i] %in% top_nm){
    name_month_amount$top5[i] = "top5"
  } else {
    name_month_amount$top5[i] = "notTop5"
  }
}

name_month_amount = subset(name_month_amount, top5 == "top5")

p <- ggplot(data = name_month_amount) +
  geom_line(mapping = aes(x = dates, y = amount, colour = name)) +
  labs(x = "Mes del Año Fiscal", 
       y = "Cantidad en Millones de $",
       title = "Gasto por Persona Mensual",
       colour = "Persona")

p <- ggplotly(p)
p

# Person QTR

name_month_amount$qtr <- numeric(length(name_month_amount$fiscal_year_period))
for (i in 1:length(name_month_amount$fiscal_year_period)){
  if (name_month_amount$fiscal_year_period[i] >= 1 && name_month_amount$fiscal_year_period[i] <= 3){
    name_month_amount$qtr[i] = paste0(name_month_amount$fiscal_year[i], "-1")
  } else if (name_month_amount$fiscal_year_period[i] >= 4 && name_month_amount$fiscal_year_period[i] <= 6){
    name_month_amount$qtr[i] = paste0(name_month_amount$fiscal_year[i], "-2")
  } else if (name_month_amount$fiscal_year_period[i] >= 7 && name_month_amount$fiscal_year_period[i] <= 9){
    name_month_amount$qtr[i] = paste0(name_month_amount$fiscal_year[i], "-3")
  } else if (name_month_amount$fiscal_year_period[i] >= 10 && name_month_amount$fiscal_year_period[i] <= 12){
    name_month_amount$qtr[i] = paste0(name_month_amount$fiscal_year[i], "-4")
  }
}

name_qtr_amount = aggregate(amount~qtr+name, name_month_amount, sum)


p <- ggplot(data = name_qtr_amount) +
  geom_line(mapping = aes(x = qtr, y = amount, colour = name, group = 1)) +
  labs(x = paste0("Trimestre del Año Fiscal (", min(data$fiscal_year), " - ", max(data$fiscal_year), ")"), 
       y = "Cantidad en Millones de $",
       title = "Gasto por Persona por Trimestre",
       colour = "Persona") + 
  theme(
    axis.text.x = element_blank(),
    axis.ticks = element_blank())

p <- ggplotly(p)
p

# Person Person
nm_nm_year = name_year[1:10, ]
nm_nm_year$amount = nm_nm_year$amount/1e6

p <- ggplot(data = nm_nm_year) + 
  geom_bar(mapping = aes(x = name, y = amount, fill = name), stat = "identity") + 
  labs(x = "Persona",
       y = "Cantidad en Millones de $",
       title = "Gasto por Persona Total",
       fill = "Persona") +
  theme(
    axis.text.x = element_blank(),
    axis.ticks = element_blank())

p <- ggplotly(p)
p
