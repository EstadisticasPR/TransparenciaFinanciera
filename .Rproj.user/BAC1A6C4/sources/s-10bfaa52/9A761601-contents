library(ggplot2)
library(plotly)

data <- read.csv("transparencia.csv")

# Account Type A~o
acc_year = aggregate(amount~account, data, sum)
acc_year = acc_year[order(-acc_year$amount),]
top_acc = acc_year[1:10, 1]

acc_year_amount = aggregate(amount~fiscal_year+account, data, sum)
acc_year_amount$amount = acc_year_amount$amount/1e6

acc_year_amount$top5 = numeric(length(acc_year_amount$account))

for (i in 1:length(acc_year_amount$account)){
  if (acc_year_amount$account[i] %in% top_acc){
    acc_year_amount$top5[i] = "top5"
  } else {
    acc_year_amount$top5[i] = "notTop5"
  }
}

acc_year_amount = subset(acc_year_amount, top5 == "top5")

p <- ggplot(data = acc_year_amount) +
  geom_line(mapping = aes(x = fiscal_year, y = amount, colour = account)) +
  labs(x = "Año Fiscal",
       y = "Cantidad en Millones de $",
       title = "Gasto por Tipo de Cuenta Anual", 
       colour = "Tipo de Cuenta")

p <- ggplotly(p)
p

# Account Type Mes

acc_month_amount = aggregate(amount~fiscal_year_period+account+fiscal_year, data, sum)
acc_month_amount$amount = acc_month_amount$amount/1e6
acc_month_amount$dates <- paste0(acc_month_amount$fiscal_year, "/", acc_month_amount$fiscal_year_period, "/1")

acc_month_amount$dates <- as.Date(acc_month_amount$dates)

acc_month_amount$top5 = numeric(length(acc_month_amount$account))

for (i in 1:length(acc_month_amount$account)){
  if (acc_month_amount$account[i] %in% top_acc){
    acc_month_amount$top5[i] = "top5"
  } else {
    acc_month_amount$top5[i] = "notTop5"
  }
}

acc_month_amount = subset(acc_month_amount, top5 == "top5")

p <- ggplot(data = acc_month_amount) +
  geom_line(mapping = aes(x = dates, y = amount, colour = account)) +
  labs(x = "Mes del Año Fiscal", 
       y = "Cantidad en Millones de $",
       title = "Gasto por Tipo de Cuenta Mensual",
       colour = "Tipo de Cuenta")

p <- ggplotly(p)
p

# Account Type QTR

acc_month_amount$qtr <- numeric(length(acc_month_amount$fiscal_year_period))
for (i in 1:length(acc_month_amount$fiscal_year_period)){
  if (acc_month_amount$fiscal_year_period[i] >= 1 && acc_month_amount$fiscal_year_period[i] <= 3){
    acc_month_amount$qtr[i] = paste0(acc_month_amount$fiscal_year[i], "-1")
  } else if (acc_month_amount$fiscal_year_period[i] >= 4 && acc_month_amount$fiscal_year_period[i] <= 6){
    acc_month_amount$qtr[i] = paste0(acc_month_amount$fiscal_year[i], "-2")
  } else if (acc_month_amount$fiscal_year_period[i] >= 7 && acc_month_amount$fiscal_year_period[i] <= 9){
    acc_month_amount$qtr[i] = paste0(acc_month_amount$fiscal_year[i], "-3")
  } else if (acc_month_amount$fiscal_year_period[i] >= 10 && acc_month_amount$fiscal_year_period[i] <= 12){
    acc_month_amount$qtr[i] = paste0(acc_month_amount$fiscal_year[i], "-4")
  }
}

acc_qtr_amount = aggregate(amount~qtr+account, acc_month_amount, sum)


p <- ggplot(data = acc_qtr_amount) +
  geom_line(mapping = aes(x = qtr, y = amount, colour = account, group = 1)) +
  labs(x = paste0("Trimestre del Año Fiscal (", min(data$fiscal_year), " - ", max(data$fiscal_year), ")"), 
       y = "Cantidad en Millones de $",
       title = "Gasto por Tipo de Cuenta Mensual",
       colour = "tipo de Cuenta") + 
  theme(
    axis.text.x = element_blank(),
    axis.ticks = element_blank())

p <- ggplotly(p)
p

# Account Account
acc_acc_year = acc_year[1:10, ]

p <- ggplot(data = acc_acc_year) + 
  geom_bar(mapping = aes(x = account, y = amount, fill = account), stat = "identity") + 
  labs(x = "Tipo de Cuenta",
       y = "Cantidad en Millones de $",
       title = "Gasto por Tipo de Cuenta Total",
       fill = "Tipo de Cuenta") +
  theme(
    axis.text.x = element_blank(),
    axis.ticks = element_blank())

p <- ggplotly(p)
p
